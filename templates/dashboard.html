<!-- templates/dashboard.html - Add WebSocket support -->
{% extends "base.html" %} {% block title %}Dashboard - Nova Hub{% endblock %} {%
block content %}
<h1>Dashboard</h1>

<!-- Connection status indicator -->
<div
    x-data="{ connected: false }"
    style="text-align: right; margin-bottom: 1rem"
>
    <small>
        <span x-show="connected" style="color: var(--ins-color)"
            >● Connected</span
        >
        <span x-show="!connected" style="color: var(--del-color)"
            >● Disconnected</span
        >
    </small>
</div>

<!-- Stats Overview (existing content) -->
<div id="stats-grid" class="grid">
    <div class="stat-card">
        <div class="stat-label">Total Packets</div>
        <div class="stat-value" id="stat-total-packets">
            {{ stats.total_packets }}
        </div>
        <small>All time</small>
    </div>

    <div class="stat-card">
        <div class="stat-label">Active Clients</div>
        <div class="stat-value" id="stat-active-clients">
            {{ stats.active_clients }}
        </div>
        <small id="stat-total-clients">{{ stats.total_clients }} total</small>
    </div>

    <div class="stat-card">
        <div class="stat-label">Active Leagues</div>
        <div class="stat-value" id="stat-active-leagues">
            {{ stats.active_leagues }}
        </div>
        <small>BRE & FE</small>
    </div>

    <div class="stat-card">
        <div class="stat-label">Pending Alerts</div>
        <div
            class="stat-value"
            id="stat-pending-alerts"
            style="color: {% if stats.pending_alerts > 0 %}var(--del-color){% else %}var(--ins-color){% endif %}"
        >
            {{ stats.pending_alerts }}
        </div>
        <small>Sequence gaps</small>
    </div>
</div>

<!-- Rest of dashboard content... -->
{{ super() }} {% endblock %} {% block extra_scripts %}
<!-- Chart.js charts (existing) -->
<script>
    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: {{ activity_chart_labels | tojson }},
            datasets: [{
                label: 'Packets',
                data: {{ activity_chart_data | tojson }},
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // League Chart
    const leagueCtx = document.getElementById('leagueChart').getContext('2d');
    const leagueChart = new Chart(leagueCtx, {
        type: 'doughnut',
        data: {
            labels: {{ league_chart_labels | tojson }},
            datasets: [{
                data: {{ league_chart_data | tojson }},
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ]
            }]
        },
        options: { responsive: true }
    });

    // WebSocket connection for real-time updates
    (function() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
        let ws;
        let reconnectTimeout;

        function connect() {
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('[WebSocket] Connected');
                document.querySelector('[x-data]').__x.$data.connected = true;

                // Clear reconnect timeout
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('[WebSocket] Received:', data.type);

                switch(data.type) {
                    case 'initial_stats':
                    case 'stats_update':
                        updateStats(data.stats);
                        break;

                    case 'packet_received':
                        showNotification(`Packet received: ${data.filename}`);
                        // Refresh activity feed
                        setTimeout(() => location.reload(), 1000);
                        break;

                    case 'processing_started':
                        showNotification('Processing started...');
                        break;

                    case 'processing_complete':
                        showNotification('Processing complete!');
                        // Refresh stats and charts
                        setTimeout(() => location.reload(), 1000);
                        break;

                    case 'alert_created':
                        showNotification('⚠️ New sequence gap detected', 'warning');
                        break;
                }
            };

            ws.onerror = function(error) {
                console.error('[WebSocket] Error:', error);
            };

            ws.onclose = function() {
                console.log('[WebSocket] Disconnected');
                document.querySelector('[x-data]').__x.$data.connected = false;

                // Reconnect after 5 seconds
                reconnectTimeout = setTimeout(connect, 5000);
            };
        }

        function updateStats(stats) {
            document.getElementById('stat-total-packets').textContent = stats.total_packets;
            document.getElementById('stat-active-clients').textContent = stats.active_clients;
            document.getElementById('stat-active-leagues').textContent = stats.active_leagues;

            const alertsElem = document.getElementById('stat-pending-alerts');
            alertsElem.textContent = stats.pending_alerts;
            alertsElem.style.color = stats.pending_alerts > 0 ? 'var(--del-color)' : 'var(--ins-color)';
        }

        function showNotification(message, type = 'info') {
            // Simple notification (could be improved with a proper toast library)
            const notification = document.createElement('article');
            notification.className = `alert-box ${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '1rem';
            notification.style.right = '1rem';
            notification.style.zIndex = '1000';
            notification.style.minWidth = '300px';

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Start connection
        connect();

        // Keepalive ping every 30 seconds
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
            }
        }, 30000);
    })();
</script>
{% endblock %}
