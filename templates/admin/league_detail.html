<!-- templates/admin/league_detail.html -->
{% extends "base.html" %}
{% block title %}{{ league.name }} - Nova Hub{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <ol>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/admin">Admin</a></li>
        <li><a href="/admin/leagues">Leagues</a></li>
        <li>{{ league.name }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<h1>{{ league.name }}</h1>

<article>
    <h2>League Details</h2>
    <table>
        <tr>
            <th>League ID</th>
            <td><code>{{ league.full_id }}</code></td>
        </tr>
        <tr>
            <th>Game Type</th>
            <td>
                {% if league.game_type == 'B' %}
                <span class="badge">BRE</span> Barren Realms Elite
                {% else %}
                <span class="badge">FE</span> Falcon's Eye
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Description</th>
            <td>{{ league.description or 'â€”' }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if league.is_active %}
                <span class="badge success">Active</span>
                {% else %}
                <span class="badge">Inactive</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Created</th>
            <td>{{ league.created_at }}</td>
        </tr>
    </table>
</article>

<!--<article>
    <h2>Dosemu Configuration</h2>
    <table>
        <tr>
            <th>Dosemu Path</th>
            <td>{{ league.dosemu_path or 'Not configured' }}</td>
        </tr>
        <tr>
            <th>Game Executable</th>
            <td>{{ league.game_executable or 'Not configured' }}</td>
        </tr>
    </table>
</article>-->

<article>
    <h2>League Membership</h2>
    <p>BBS clients that are members of this league:</p>

    {% if members %}
    <table role="grid">
        <thead>
            <tr>
                <th>BBS Name</th>
                <th>BBS ID</th>
                <th>Fidonet Address</th>
                <th>Client ID</th>
                <th>Joined</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td><strong>{{ member.bbs_name }}</strong></td>
                <td class="mono">
                    {% if member.bbs_index %}
                    <span title="Hex: 0x{{ '%02X' | format(member.bbs_index) }}">{{ member.bbs_index }}</span>
                    {% else %}
                    <span style="color: var(--del-color);">Not Assigned</span>
                    {% endif %}
                </td>
                <td class="mono">
                    {% if member.fidonet_address %}
                    {{ member.fidonet_address }}
                    {% else %}
                    <span style="color: var(--del-color);">Not Set</span>
                    {% endif %}
                </td>
                <td class="mono" style="font-size: 0.75rem">{{ member.client_oauth_id }}</td>
                <td>{{ member.joined_at }}</td>
                <td>
                    {% if member.membership_is_active %}
                    <span class="badge success">Active</span>
                    {% else %}
                    <span class="badge">Inactive</span>
                    {% endif %}
                </td>
                <td>
                    <button onclick="showEditBBSIndex({{ member.membership_id }}, {{ member.bbs_index or 0 }})" class="secondary" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;">
                        {% if member.bbs_index %}Edit{% else %}Set{% endif %} BBS ID
                    </button>
                    <button onclick="showEditFidonet({{ member.membership_id }}, '{{ member.fidonet_address or '' }}')" class="secondary" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;">
                        {% if member.fidonet_address %}Edit{% else %}Set{% endif %} Fidonet
                    </button>
                    <form method="post" action="/admin/leagues/{{ league.id }}/members/{{ member.client_id }}/remove" style="display: inline;">
                        <button type="submit" class="secondary" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;" onclick="return confirm('Remove {{ member.bbs_name }} from this league?');">
                            Remove
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p><em>No clients are currently members of this league.</em></p>
    {% endif %}

    <details>
        <summary>Add Client to League</summary>
        <form method="post" action="/admin/leagues/{{ league.id }}/members/add">
            <label for="client_id">
                Select Client
                <select id="client_id" name="client_id" required>
                    <option value="">Choose a client...</option>
                    {% for client in available_clients %}
                    <option value="{{ client.id }}">{{ client.bbs_name }} - {{ client.client_id }}</option>
                    {% endfor %}
                </select>
            </label>

            <label for="bbs_index">
                BBS ID (required)
                <input type="number" id="bbs_index" name="bbs_index" min="1" max="255" required placeholder="e.g., 2" />
                <small>Integer between 1-255. <span id="bbs_hex_hint"></span></small>
            </label>

            <label for="fidonet_address">
                Fidonet Address (required)
                <input type="text" id="fidonet_address" name="fidonet_address" required pattern="^\d+:\d+/\d+$" placeholder="e.g., 13:10/100" />
                <small>Format: zone:net/node (e.g., 13:10/100)</small>
            </label>

            <button type="submit">Add to League</button>
        </form>
    </details>
</article>

<article>
    <h2>Statistics</h2>
    <table>
        <tr>
            <th>Total Packets</th>
            <td>{{ stats.total_packets }}</td>
        </tr>
        <tr>
            <th>Packets Processed</th>
            <td>{{ stats.processed_packets }}</td>
        </tr>
        <tr>
            <th>Processing Runs</th>
            <td>{{ stats.processing_runs }}</td>
        </tr>
    </table>
</article>

<div style="display: flex; gap: 1rem;">
    <a href="/admin/leagues/{{ league.id }}/edit" role="button">Edit League</a>
    <a href="/admin/leagues" role="button" class="secondary">Back to Leagues</a>
</div>

<!-- Modal for editing BBS ID -->
<dialog id="edit-bbs-index-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close" onclick="document.getElementById('edit-bbs-index-modal').close(); return false;"></a>
            <h3>Set BBS ID</h3>
        </header>
        <form id="edit-bbs-index-form" method="post">
            <label for="modal_bbs_index">
                BBS ID (1-255)
                <input type="number" id="modal_bbs_index" name="bbs_index" min="1" max="255" required placeholder="e.g., 2" />
                <small>Integer between 1-255. <span id="modal_bbs_hex_hint"></span></small>
            </label>
            <footer>
                <button type="submit">Save</button>
                <button type="button" class="secondary" onclick="document.getElementById('edit-bbs-index-modal').close()">
                    Cancel
                </button>
            </footer>
        </form>
    </article>
</dialog>

<!-- Modal for editing Fidonet Address -->
<dialog id="edit-fidonet-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close" onclick="document.getElementById('edit-fidonet-modal').close(); return false;"></a>
            <h3>Set Fidonet Address</h3>
        </header>
        <form id="edit-fidonet-form" method="post">
            <label for="modal_fidonet_address">
                Fidonet Address
                <input type="text" id="modal_fidonet_address" name="fidonet_address" required pattern="^\d+:\d+/\d+$" placeholder="e.g., 13:10/100" />
                <small>Format: zone:net/node (e.g., 13:10/100)</small>
            </label>
            <footer>
                <button type="submit">Save</button>
                <button type="button" class="secondary" onclick="document.getElementById('edit-fidonet-modal').close()">
                    Cancel
                </button>
            </footer>
        </form>
    </article>
</dialog>

<script>
function showEditBBSIndex(membershipId, currentIndex) {
    const modal = document.getElementById('edit-bbs-index-modal');
    const form = document.getElementById('edit-bbs-index-form');
    const input = document.getElementById('modal_bbs_index');

    form.action = `/admin/leagues/{{ league.id }}/members/${membershipId}/update-bbs-index`;
    input.value = currentIndex > 0 ? currentIndex : '';
    updateHexHint('modal_bbs_hex_hint', currentIndex > 0 ? currentIndex : null);
    modal.showModal();
}

function showEditFidonet(membershipId, currentAddress) {
    const modal = document.getElementById('edit-fidonet-modal');
    const form = document.getElementById('edit-fidonet-form');
    const input = document.getElementById('modal_fidonet_address');

    form.action = `/admin/leagues/{{ league.id }}/members/${membershipId}/update-fidonet`;
    input.value = currentAddress || '';
    modal.showModal();
}

function updateHexHint(elementId, value) {
    const hint = document.getElementById(elementId);
    if (value && value >= 1 && value <= 255) {
        const hex = value.toString(16).toUpperCase().padStart(2, '0');
        hint.textContent = `(Hex: 0x${hex})`;
    } else {
        hint.textContent = '';
    }
}

// Update hex hint as user types in add form
document.getElementById('bbs_index')?.addEventListener('input', function(e) {
    updateHexHint('bbs_hex_hint', parseInt(e.target.value));
});

// Update hex hint as user types in modal
document.getElementById('modal_bbs_index')?.addEventListener('input', function(e) {
    updateHexHint('modal_bbs_hex_hint', parseInt(e.target.value));
});
</script>

{% endblock %}
